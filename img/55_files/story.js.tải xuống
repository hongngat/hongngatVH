function showprofiledetail(user) {
    if ("function" === typeof premiumprocess) {
        premiumprocess(user);
    }
    if (user.UserId <= 0) {
        $('#btnLoginSendComment').show();
        return;
    }
    $('#txtname').val(user.FullName);
    $('#txtemail').val(user.Email);
    $('#txtaddress').val(user.Address);
    $('.sendbookmark').parent().show();
    if (user.SavedList.indexOf(contentId) >= 0) $('.sendbookmark').addClass('bookmarked');
    $('.sendbookmark').click(function (e) {
        e.preventDefault();
        $.ajax({
            url: loghost + "/client/"+($(this).hasClass('bookmarked') ? "unsaved" : "saved")+".html",
            data: {user: user.UserId, id: contentId },
            type: "POST",
            dataType: "jsonp",
            jsonp: "callback",
            success: function (data) {
                var msg = '';
                if (data.UserId > 0) { $('.sendbookmark').toggleClass('bookmarked'); }
                else {
                    switch (data.Error) {
                        case "savednologin": msg = ('Bạn chưa đăng nhập!'); break;
                        default: msg = ('Có lỗi xảy ra!'); break;
                    }
                }
            }
        });
    });
    $('#btnLoginSendComment').hide();
    if ($('#txtcontent').length > 0 && $('#txtcontent').val() != '') {
        $('#btncommentdialog').click();
    }
}
function updatebody() {

    //var lazyLoad = new LazyLoad({ elements_selector: '#abody img[data-src]' });
    //lazyLoad.loadAll();

    ////if($('#sidebar160').height() > $('#abody').height()) {
    ////    $('#abody').height($('#sidebar160').height());
    ////}
    var imageCount = $('#storybox #abody img[src],#storybox #abody img[data-src]').length + ($('#storybox img.storyavatar').length > 0 ? 1 : 0);
    var imageLoaded = $('#storybox img.storyavatar').length > 0 ? 1 : 0;
    var imageLoading = true;
    var dataindex = imageLoaded;
    $('#storybox img.storyavatar').one('load', function () {
        var w = $(this).width();
        var h = $(this).height();
        var bigsrc = $(this).attr("src");
        if (typeof bigsrc == 'undefined' || bigsrc == '') bigsrc = $(this).attr("data-src");
        bigsrc = bigsrc.replace("/480/", "/1600/").replace("/561/", "/1600/").replace("/485/", "/1600/").replace("/820/", "/1600/").replace("/665/", "/1600/").replace("/500/", "/1600/").replace("/980/", "/1600/").replace("/680/", "/1600/").replace("/660/", "/1600/");
        //$(this).parent().attr('href', bigsrc).attr('data-size', 1600 + 'x' + Math.round(1600 * h / w)).parent().attr('data-index', 0);
        imageLoaded++;
        if (imageLoading && imageLoaded >= imageCount) {
            //initPhotoSwipeFromDOM('#storybox a.fullscreen-img');
            //initPhotoSwipeFromDOM('#storybox .pswp-content__image');
            imageLoading = false;
        }
    }).error(function () {
        imageLoaded++;
        if (imageLoading && imageLoaded >= imageCount) {
            //initPhotoSwipeFromDOM('#storybox a.fullscreen-img');
            //initPhotoSwipeFromDOM('#storybox .pswp-content__image');
            imageLoading = false;
        }
    }).each(function () {
        if (this.complete) $(this).load();
    });
    $("#storybox #abody img[src],#storybox #abody img[data-src]").one("load", function () {
        var src = $(this).attr('src');
        if (typeof src == 'undefined' || src == '') src = $(this).attr("data-src");
        if (src.toLowerCase().indexOf("publishingimages") > 0) { return; }
        //console.log(src);
        var width = bodywidth;
        if ($(this).parents('#livestream').length > 0) {
            width = width - 120;
        }
        if ($(this).parents('table').length > 1) { width = width - 20; }

        if (src.indexOf('https://image.thanhnien.vn') == 0) {
            if (src.indexOf('?') > 0) src = src.substr(0, src.indexOf('?'));
        }
        if ($(this).parents('.twentytwenty-container').length > 0) {
            $(this).attr('src', $(this).attr('data-src'));
            $("#abody .twentytwenty-container").twentytwenty({ default_offset_pct: 0.7 });
        } else if ($(this).hasClass('logimg') || $(this).hasClass('storyavatar') || $(this).parent().hasClass('jwplayer1')) {
            //do nothing
        } else if ($(this).parents('.imageads').length > 0) {
            $(this).attr('data-src', src).attr('src', src).css('max-width', width + 'px');
            try { $(this).style.setProperty('max-width', width + 'px', 'important'); } catch (e) { }//.width(width).height('auto');
            if ($(this).width() > width) { $(this).width(width).height('auto'); } else { $(this).width('').height(''); }
        } else if (src.toLowerCase().indexOf('/uploaded/') < 0 || $(this).parents('.image').length > 0 || $(this).parents('blockquote').length > 0) {
            if ($(this).width() > width) { $(this).width(width).height('auto'); } else { $(this).width('').height(''); }
        } else {
            if (!ismobile) {
                if (!isOldContent) {
                    //if ($(this).width() > $(this).height()) {
                    //    //horizon
                    //    $(this).attr('src', src.replace('/500/', '/' + width + '/')).width(width).height('auto');
                    //    $(this).parents('.imagefull').addClass('done').width($(this).parents('article.answer').length > 0 ? '100%' : width).height('auto');
                    //} else {
                    //    $(this).width(500).height('auto'); //.attr('src', src + '?width=500' + '&encoder=wic&subsampling=444')
                    //    $(this).parents('.imagefull:not(.done)').width($(this).parents('article.answer').length > 0 ? '100%' : 500).height('auto');
                    //}
                } else {
                    if ($(this).width() > width) { $(this).width($(this).parents('article.answer').length > 0 ? '100%' : width).height('auto'); }
                    else { $(this).width('').height(''); }
                }
            }

        }
        if (src.toLowerCase().indexOf('/uploaded/') >= 0) {
            var updateHtml = true;
            if ($(this).parent().prop("tagName").toLowerCase() == 'a' || $(this).parent().hasClass('jwplayer1') || $(this).parents('.twentytwenty-container, .cms-video').length > 0) {
                updateHtml = false;
            }
            if (updateHtml) {


                if ($(this).next('br').length) {
                    $(this).next('br').first().remove();
                }
                var title = '';
                if ($(this).parents('figure').length > 0) {
                    title = $(this).parents('figure:first').find('figcaption').text().escape().trim();
                    if (title != '') {
                        $(this).parents('figure:first').find('figcaption').replaceWith('<div class="pswp-content__caption"><i class="spr spr--image"></i><div class="imgcaption">' + title + '</div></div>');
                    }
                }
                if (title == '' && $(this).next().hasClass('pswp-content__caption')) {
                    title = $(this).next().text().escape().trim();
                    if (title != '') {
                        $i = $(this).next().find('i');
                        if ($i.length > 0) {
                            $i.attr('class', 'spr spr--image');
                        }
                        else {
                            $(this).next().prepend('<i class="spr spr--image"></i>');
                        }
                    }
                }
                if (title == '' && $(this).parent().find('div.pswp-content__caption').length > 0) {
                    title = $(this).parent().find('div.pswp-content__caption').text().escape().trim();
                    if (title != '') {
                        $i = $(this).parent().find('div.pswp-content__caption').find('i');
                        if ($i.length > 0) {
                            $i.attr('class', 'spr spr--image');
                        }
                        else {
                            $(this).parent().find('div.pswp-content__caption').prepend('<i class="spr spr--image"></i>');
                        }
                    }
                }
                if (title == '' && $(this).parent().find('span').length > 0) {
                    title = $(this).parent().find('span').text().escape().trim();
                    if (title != '') {
                        $(this).parent().find('span').replaceWith('<div class="pswp-content__caption"><i class="spr spr--image"></i><div class="imgcaption">' + title + '</div></div>');
                    }
                }
                if (title == '') {
                    if ($(this).parent().prop("tagName").toLowerCase() == 'div') {
                        title = $(this).parent().text().escape().trim();
                        if (title == '') {
                            title = $(this).parent().next().text().escape().trim();
                        }
                    }
                }
                if (title == '') {
                    var p = $(this).parent().clone();
                    p.find('img').remove();
                    title = p.text().escape().trim();
                }
                try {
                    title = title.trim();
                } catch (abc) {
                    //do smt
                }
                var w = $(this).width();
                var h = $(this).height();
                var src1 = src.replace('https://image.thanhnien.vn', '');
                if (src1.indexOf('?') > 0) src1 = src1.substr(0, src1.indexOf('?'));
                var bigsrc = $(this).attr("src");
                if (typeof bigsrc == 'undefined' || bigsrc == '') bigsrc = $(this).attr('data-src');
                bigsrc = bigsrc.replace("/480/", "/1600/").replace("/561/", "/1600/").replace("/485/", "/1600/").replace("/820/", "/1600/").replace("/665/", "/1600/").replace("/500/", "/1600/").replace("/980/", "/1600/").replace("/680/", "/1600/").replace("/660/", "/1600/");

                $(this).wrap('<div class="pswp-content__wrapimage"></div>');
                //$(this).parent().prepend('<a href="javascript:void(0);" class="fs-icon"><i class="icon-size-fullscreen"></i></a>');
                $(this).wrap('<div class="pswp-content__image"></div>').wrap('<figure itemprop="associatedMedia" data-index="' + dataindex + '"></figure>');
                //$(this).wrap('<a href="' + bigsrc + '" target="_blank" itemprop="contentUrl" data-size="' + 1600 + 'x' + Math.round(1600 * h / w) + '"></a>');
                $(this).parent().after('<span>' + title.replace(/'/g, "&rsquo;").replace(/"/g, '&quot;') + '</span>');
                //var $obj = $(this);
                //while (!$obj.parent().hasClass('cms-body')) {
                //    $obj = $obj.parent();
                //}
                //$obj.addClass('pswp-content__wrapimage');
                dataindex++;
            }
        }
        imageLoaded++;
        if (imageLoading && imageLoaded >= imageCount) {
            //initPhotoSwipeFromDOM('#storybox a.fullscreen-img');
            //initPhotoSwipeFromDOM('#storybox .pswp-content__image');
            imageLoading = false;
        }
    }).error(function () {
        imageLoaded++;
        if (imageLoading && imageLoaded >= imageCount) {
            //initPhotoSwipeFromDOM('#storybox a.fullscreen-img');
            //initPhotoSwipeFromDOM('#storybox .pswp-content__image');
            imageLoading = false;
        }
    }).each(function () {
        if (this.complete) $(this).load();
    });
    if ((typeof TNO_DetailFooter_Left_v3 == "undefined" || TNO_DetailFooter_Left_v3.aNodes.length == 0) && (typeof TNO_DetailFooter_Right_v3 == "undefined" || TNO_DetailFooter_Right_v3.aNodes.length == 0)) { $("#detailsbottombanner").remove(); }
    //window.setTimeout(function () { initPhotoSwipeFromDOM('#storybox .pswp-content__image'); }, 3000);

    $('#storybox #abody div[style]').each(function () {
        $(this).attr('style', $(this).attr('style').replace('margin', 'nomargin'));
    });
    $('#abody td[style*="background-color"]').each(function () {
        var parent = $(this).parents('table');
        if (parent.length < 2) {
            parent = $(this).parents('table:first');
            parent.addClass('quote--full');
            parent.css('width', 'auto');
        } else {
            parent = $(parent[1]);
        }
        if (parent.hasClass('quote')) return;
        if ($(this).attr('style').indexOf('#fae6ab') > 0) {
            parent.addClass('quote quote--yellow');
        } else if ($(this).attr('style').indexOf('#e3edf7') > 0) {
            parent.addClass('quote quote--cyan');
        } else if ($(this).attr('style').indexOf('#ffffff') > 0) {
            parent.addClass('quote quote--white');
        } else {
            //parent.addClass('quote');
        }
    });
    $('#abody table.quote--full').addClass('quote');
    $('#abody img[src*="news-pbdes.jpg"],#abody img[src*="/img-thanhnien/quote1.gif"]').each(function () {
        var parent = $(this).parents('table:first').parents('table:first');
        if (parent.length > 0) {
            parent.addClass('quote quote--grey');
            parent.find("table:first").css('background-color', '#f1f1f1');
            parent.find('img[src*="news-pbdes.jpg"],img[src*="/img-thanhnien/quote1.gif"]').attr('src', '//static.thanhnien.vn/v3/App_Themes/img/quote2.png');
            parent.find('img[src*="news-pbdes-2.jpg"],img[src*="/img-thanhnien/quote2.gif"]').remove();
        }
    });
    $('#abody .quote.has-icon').each(function () {
        if ($(this).find('i').length == 0) {
            $(this).prepend('<i class="spr spr--quote"></i>');
        }
    });
    $('#abody .quotetable .quote').each(function () {
        $(this).parents('table.quotetable').replaceWith($(this));
    })
    $('#abody .cms-video').each(function () {
        $(this).find('a[img=""]').attr('img', '//static.thanhnien.vn/App_Themes/images/bg-video-thanhnien.png');
        $(this).find('img[src=""]').attr('src', '//static.thanhnien.vn/App_Themes/images/bg-video-thanhnien.png');

        var title = '';
        if ($(this).parents('figure').length > 0) {
            title = $(this).parents('figure:first').find('figcaption').text().escape().trim();
            if (title != '') {
                $(this).parents('figure:first').find('figcaption').replaceWith('<div class="pswp-content__caption"><i class="spr spr--video"></i><div class="imgcaption">' + title + '</div></div>');
            }
        }
        if (title == '' && $(this).parents("table.video:first").find('.pswp-content__caption').length > 0) {
            title = $(this).parents("table.video:first").find('.pswp-content__caption').text().escape().trim();
            if (title != '') {
                $i = $(this).parents("table.video:first").find('.pswp-content__caption').find('i');
                if ($i.length > 0) {
                    $i.attr('class', 'spr spr--video');
                }
                else {
                    $(this).parents("table.video:first").find('.pswp-content__caption').prepend('<i class="spr spr--video"></i>');
                }
            }
        }
        if (title == '' && $(this).parent('div').next().length > 0) {
            title = $(this).parent('div').next('div').text().escape().trim();
            if (title != '') {
                $(this).parent('div').next('div').addClass('imgcaption').wrap('<div class="pswp-content__caption"></div>').before('<i class="spr spr--video"></i>');
            }
        }

    });
    if ($('#storybox #chapeau').html() == '') {
        $('#storybox #chapeau').html($('#storybox #abody h2:first').html());
        $('#storybox #abody h2:first').remove();
    }
    if ($('#storybox #chapeau').html().indexOf('(TNO)') >= 0) {
        if (_prefixDesc != '') $('#storybox #chapeau').html($('#storybox #chapeau').html().replace('(TNO)', ''));
    }
    $('#storybox #abody table.image').attr('width', '');
    //$('#storybox #abody object, #storybox #abody embed, #storybox #abody iframe, #storybox #abody video').each(function () {
    //    $(this).attr("width", '100%');
    //});
    $('#storybox #abody img, #storybox #abody table').each(function () { if ($(this).width() > bodywidth) { $(this).width(bodywidth).height('auto'); } });
    $('#storybox #abody table.video').css('width', bodywidth + 'px');

    $('<div style="clear:both;"></div>').insertAfter('#storybox #abody table.video');
    //$('#abody .imageads img').each(function() {
    //    $(this).attr('src', $(this).attr('src').replace('?width=500', '?width=' + bodywidth));
    //});

    $('#storybox #abody .rrHandle').remove();
    $('#storybox #abody article.story a').attr('target', '_blank');
    //$(document).ready(function () {
        window.setTimeout(function () {
            $('#storybox #abody img, #storybox #abody table').each(function () { if ($(this).width() > bodywidth) { $(this).width(bodywidth).height('auto'); } });
        }, 5000);
        $('#storybox #abody img, #storybox #abody table').height('auto');
        var voteIds = '';
        $('#storybox #abody div.article-poll').each(function () {
            var voteid = $(this).attr('voteid');
            $(this).addClass('poll');
            //showvote('', voteid);
            voteIds += voteid + ",";
        });
        if (voteIds != '') {
            showVotes('', voteIds);
        }
    //});
    //galleria
    if ($('.article-galleria').length > 0) { Galleria.loadTheme('//static.thanhnien.vn/JScripts/galleria/themes/classic/galleria.classic.min.js'); Galleria.run('.article-galleria'); }

    //$("#abody .twentytwenty-container").twentytwenty({ default_offset_pct: 0.7 });
    //video
    var autoplay = true;
    //$('#abody .hi-icon, #videoavatar .hi-icon, .video-trigger').click(function (e) {
    //    e.preventDefault();
    //    var video = $(this).attr('video');
    //    var img = $(this).attr('img');
    //    var container = $(this).attr('con');
    //    if ($('#' + container).parent('div#fakevideocontainer').length <= 0) {
    //        $('#' + container).wrap('<div id="fakevideocontainer"></div>');
    //    }
    //    $('#' + container).parent().width($('#' + container).width()).height($('#' + container).height());
    //    if (!ismobile) {
    //        $('#' + container).parent().css('background-image', 'url(' + img + ')').css('background-size', 'cover');
    //    } else {
    //        $('#' + container).parent().css('background-image', '').css('background-size', '');
    //    }
    //    var w = $('#' + container).width();
    //    var h = $('#' + container).height();
    //    $('#' + container).html('');
    //    //console.log(('#' + container) + ' - ' + video);
    //    showvideofull(container, video, img, w, h);
    //    $('#' + container).find('.video-effect, .jwplayer1').remove();
    //    if ($(this).parent().is('li')) {
    //        $('#post-player-container').off('click');
    //    } else {
    //        $(this).off('click');
    //    }
    //    $(this).addClass('played');
    //    $('#' + container).on('play', function () {
    //        $('#fakevideocontainer').removeAttr('style').removeAttr('id');
    //    });
    //});
    //$('#abody .player-effect, #videoavatar').click(function (e) {
    //    if ($(e.target).is('.hi-icon')) return;
    //    e.preventDefault();
    //    e.stopPropagation();
    //    if ($(this).find('.hi-icon').length > 0) {
    //        $(this).find('.hi-icon:first').click();
    //    }
    //});


    if ($('#livetimeline').length > 0) {
        $('#abody #livestream > div.hastitle').each(function () {
            $('#livetimeline').append('<li><a href="#' + $(this).attr('id') + '"><time>' + $(this).find('time').html() + '</time><span>' + $(this).find('.livetitle strong').html() + '</span></a></li>');
        });
        if ($('#livetimeline li').length > 1) {
            $('#timelineinit').remove();
        }
        $('#livetimeline').height($(window).height() - 80);
        updatestickypos();
        $('#livetimeline li > a').click(function (e) {
            e.preventDefault();
            $("html, body").animate({ scrollTop: $($(this).attr('href')).offset().top - 30 }, "slow");
        });
    }

    $('#abody .cms-video').each(function () {
        var title = '';
        if ($(this).parents('td').length > 0) {
            var p = $(this).parents('td:first').clone();
            p.find('.cms-video').remove();
            title = p.html();
        }
        if (title == '' && $(this).parent().find('span').length > 0) {
            title = $(this).parent().find('span').text().escape();
        }
        if (title == '') {
            if ($(this).parent().prop("tagName").toLowerCase() == 'div') {
                title = $(this).parent().text();
                if (title == '') {
                    title = $(this).parent().next().text();
                }
            }
        }
        if (title == '') {
            var p = $(this).parent().clone();
            p.find('.cms-video').remove();
            title = p.html();
        }
        try {
            title = title.trim();
        } catch (abc) {
            //do smt
        }
        //console.log(title);
        if (title != '') {
            $(this).find('video').attr('video-title', strip_tags(title));
        }
    });
    if ($('#abody').contents().filter(function () { return this.nodeType == Node.TEXT_NODE; }).length > 0) { $('#abody').wrapInner('<div></div>'); }
}
if ($('#abody #premiumcontent').length == 0) {
    updatebody();
}

function showVotes(_contentid, voteIds) {
    $.ajax({
        type: "POST",
        url: "/ajax/voteboxes.aspx",
        data: { ids: voteIds }
    }).done(function (msg) {
        var boxes = $('<div>' + msg + '</div>').find('.votebox');
        boxes.each(function () {
            var voteid = $(this).attr('voteid');
            var box = $(this).html();
            $('#storybox' + _contentid + ' #votebox' + voteid).html(box);
            $('#storybox' + _contentid + ' #votebox' + voteid).show();
        });
        $('#storybox' + _contentid + ' .votebutton').click(function (e) {
            e.preventDefault(); e.stopPropagation();
            if ($(this).parents('.voteboxgroup').length > 0) { return; }
            var id = $(this).attr('rel');
            $('#storybox' + _contentid + ' #loadingvote' + id).css('display', 'inline');
            var order = $('#storybox' + _contentid + ' input:radio[name=vote' + id + ']:checked');
            if (order.length == 0 || parseInt(order.val()) == 'NaN') {
                alert('Bạn chưa chọn mục nào.'); return false;
            }
            logvote(id, order.val());
            alert('Cảm ơn bạn đã bình chọn. Xin mời bạn bấm OK để xem kết quả!');
            voteresult(_contentid, id);
            window.setTimeout(function () { $('#storybox' + _contentid + ' #loadingvote' + id).hide(); }, 5000);
        });
        $('#storybox' + _contentid + ' .voteresult').click(function (e) {
            e.preventDefault(); e.stopPropagation();
            if ($(this).parents('.voteboxgroup').length > 0) { return; }
            var id = $(this).attr('rel');
            $('#storybox' + _contentid + ' #loadingvote' + id).css('display', 'inline');
            voteresult(_contentid, id);
            window.setTimeout(function () { $('#storybox' + _contentid + ' #loadingvote' + id).hide(); }, 5000);
        });
        $('#storybox' + _contentid + ' .voteboxgroup .poll:last .votebutton').click(function (e) {
            e.preventDefault(); e.stopPropagation();
            var voteIds = '', voteAns = '';
            var voteDone = true;
            $(this).parents('.voteboxgroup').find('.votebutton').each(function () {
                var voteid = $(this).attr('rel');
                $('#storybox' + _contentid + ' #loadingvote' + voteid).css('display', 'inline');
                var order = $('#storybox' + _contentid + ' input:radio[name=vote' + voteid + ']:checked');
                if (order.length == 0 || parseInt(order.val()) == 'NaN') {
                    alert('Bạn chưa chọn mục nào.'); voteDone = false; return false;
                }
                voteIds += voteid + ",";
                voteAns += order.val() + ",";
            });
            if (!voteDone) { return; }
            logvotes(voteIds, voteAns);
            alert('Cảm ơn bạn đã bình chọn. Xin mời bạn bấm OK để xem kết quả!');
            window.setTimeout(function () { voteresults(_contentid, voteIds); }, 1000);
        });
        $('#storybox' + _contentid + ' .voteboxgroup .poll:last .voteresult').click(function (e) {
            e.preventDefault(); e.stopPropagation();
            var voteIds = '';
            $(this).parents('.voteboxgroup').find('.voteresult').each(function () {
                var voteid = $(this).attr('rel');
                voteIds += voteid + ",";
            });
            voteresults(_contentid, voteIds);
        });
    });
}
function voteresults(_contentid, voteIds) {
    $.ajax({
        type: "POST",
        url: "/ajax/voteboxes.aspx",
        data: { ids: voteIds, type: 'result' }
    }).done(function (msg) {
        //$('#storybox' + _contentid + ' #votebody' + _id).html(msg);
        var boxes = $('<div>' + msg + '</div>').find('.votebox');
        boxes.each(function () {
            var voteid = $(this).attr('voteid');
            var box = $(this).html();
            $('#storybox' + _contentid + ' #votebody' + voteid).html(box);
        });
        $('#storybox' + _contentid + ' .voteboxgroup .voteresetbtn').attr('onclick', '');
        $('#storybox' + _contentid + ' .voteboxgroup .poll:last .voteresetbtn').click(function (e) {
            var voteIds = ''
            $('#storybox' + _contentid + ' .voteboxgroup .poll').each(function () {
                var voteid = $(this).attr('voteid');
                voteIds += voteid + ",";
            })
            if (voteIds != '') {
                showVotes('', voteIds);
            }
        });
    });
}
$('.sendprint').click(function (e) {
    e.preventDefault();
    var ow = (window.open("/print.html", "_blank", 'height=800,width=1080,status=yes,location=no,menubar=no,resizable=yes,scrollbars=yes,titlebar=yes,top=50,left=100', true));
});

//comment
$('#txtcontent').click(function (e) {
    e.preventDefault();
    $(this).parent().addClass("full");
    $('#btnSendComment').attr('parent', '0');
});
$('.morecomment').click(function (e) {
    e.preventDefault();
    $('.zone--comment__usercomment.hidden').removeClass('hidden');
    $(this).remove();
});
var commentcount = ccc;
insertCity('');
$('.comment-item time').each(function () {
    var d = new Date(eval($(this).attr('rel')));
    d.setHours(d.getHours() - 7);
    var n = new Date();
    if (d > n) {
        $(this).parents('.comment-item').hide();
        commentcount--;
    }
});
if (commentcount != ccc) {
    $('#commentcount, #ccc').val(commentcount);
}
$('#btncommentdialog').click(function (e) {
    if ($('#txtcontent').val() == '') {
        alert('Bạn chưa nhập đủ thông tin.');
        e.preventDefault();
        e.stopPropagation();
        return;
    }
});
$('#commendorder').change(function (e) {

});
$('#btnLoginSendComment').click(function (e) {
    e.preventDefault();
    $('#Modal').modal('hide');
    $('#userprofile > a').click();
});
$('#btnSendComment').click(function (e) {
    e.preventDefault();
    var name = $('#txtname').val();
    var email = $('#txtemail').val();
    var address = $('#txtaddress').val();
    var content = $('#txtcontent').val();

    if (name == '' || address == '' || content == '') {
        alert('Bạn chưa nhập đủ thông tin.');
        return;
    }
    $.ajax({
        type: "POST",
        url: loghost + "/ajax/postcomment.aspx",
        data: { cid: contentId, name: name, email: email, title: window.title, content: content, address: address, parent: $(this).attr('parent') },
        xhrFields: {
            withCredentials: true
        }
    }).done(function (msg) {
        alert(msg);
        if (msg == 'Cảm ơn bạn đã đóng góp ý kiến!') {
            $('#btnModalClose').click();
            $('#replybox').remove();
            $('#txtcontent').val('');
            $('#btnSendComment').attr('parent', '0');
        }
    });
});
//<div class="reply-area hidden"><textarea class="form-control" placeholder="Viết bình luận..."></textarea><a class="btn btn-primary" href="#">Gửi bình luận</a></div>
$('.replybtn').click(function (e) {
    e.preventDefault();
    var parentId = $(this).attr('rel');
    $('#replybox').remove();
    $('#commentitem' + parentId).append('<div class="reply-area" id="replybox"><textarea class="form-control" placeholder="Trả lời bình luận..." id="replycontent"></textarea><a class="btn btn-primary" href="#" id="sendreply" rel="' + parentId + '">Gửi bình luận</a></div>');
    $('#sendreply').click(function (e) {
        e.preventDefault();
        e.stopPropagation();
        $('#txtcontent').val($('#replycontent').val());
        $('#btnSendComment').attr('parent', $(this).attr('rel'));
        $('#btncommentdialog').click();
    });
});
$('.likebtn').click(function (e) {
    e.preventDefault();
    var id = $(this).attr('rel');
    var i = getcookie("commentliked");
    if (i != null) {
        var s = new Array;
        s = JSON.parse(i);
        if (s.indexOf(id) >= 0) {
            alert('Bạn đã thích phản hồi này rồi.');
            return;
        }
    }
    $.ajax({
        type: "POST",
        url: "/ajax/reportcomment.aspx",
        data: { id: id, type: "like" },
        success: function (msg) {
            if (parseInt(msg) != undefined && parseInt(msg) > 0) {
                $('#likebtn' + id).html('<i class="fa fa-check"></i>' + msg + ' thích');
                setLikeStatus(id);
            } else if (msg == 'soon') {
                window.alert('Bạn vừa sử dụng chức năng này gần đây. Xin vui lòng nghỉ ngơi ít phút.');
            } else {
                window.alert('Có lỗi xảy ra. Xin vui lòng thử lại.');
            }
        }
    });
});
function updateLikeStatus() {
    var i = getcookie("commentliked");
    if (i != null) {
        var s = new Array;
        s = JSON.parse(i);
        var o = true;
        $.each(s, function (_i, _v) {
            $('#likebtn' + _v + ' i').attr('class', 'fa fa-check');
        });
    }
}
updateLikeStatus();
function setLikeStatus(_id) {
    var i = getcookie("commentliked");
    var s = new Array;
    if (i != null) {
        s = JSON.parse(i);
    }
    s.push(_id);
    savecookie("commentliked", JSON.stringify(s));
}
$('.reportbtn').click(function (e) {
    e.preventDefault();

    var id = $(this).attr('rel');
    $.ajax({
        type: 'POST',
        url: '/ajax/reportcomment.aspx',
        data: { id: id, type: "report" }
    }).done(function (msg) {
        if (msg == 'success') {
            window.alert('Cảm ơn bạn đã báo tin.');
            setReportStatus(id);
            $('#reportbtn' + id).remove();
        } else if (msg == 'soon') {
            window.alert('Bạn vừa sử dụng chức năng này gần đây. Xin vui lòng nghỉ ngơi ít phút.');
        } else {
            window.alert('Có lỗi xảy ra. Xin vui lòng thử lại.');
        }
    });
});

function updateReportStatus() {
    var i = getcookie("commentreported");
    if (i != null) {
        var s = new Array;
        s = JSON.parse(i);
        var o = true;
        $.each(s, function (_i, _v) {
            $('#reportbtn' + _v).remove();
        });
    }
}
updateReportStatus();
function setReportStatus(_id) {
    var i = getcookie("commentreported");
    var s = new Array;
    if (i != null) {
        s = JSON.parse(i);
    }
    s.push(_id);
    savecookie("commentreported", JSON.stringify(s));
}

//scroll
var isFloatShow = true, isLoadMore = false;
$(window).scroll(function () {
    if ($(window).scrollTop() + $(window).height() > $('footer.site-footer').offset().top + (isLoadMore ? $(window).height() / 2 : 50)) {
        if (isFloatShow) {
            if (isLoadMore) {
                $('nav.floating-bar').addClass('hidden');
                isFloatShow = false;
            } else {
                $('#othercontents .hidden').removeClass('hidden');
                isLoadMore = true;
                updatestickypos();
            }
        }
    } else {
        if (!isFloatShow) {
            $('nav.floating-bar.hidden').removeClass('hidden');
            isFloatShow = true;
        }
    }
});
if ($('#interviewform').length > 0) {
    insertCity('interview');
    $('#btnsendquestion').click(function (e) {
        e.preventDefault();
        var name = $('#txtnameinterview').val();
        var email = $('#txtemailinterview').val();
        var address = $('#txtaddressinterview').val();
        var content = $('#txtcontentinterview').val();

        if (name == '' || address == '' || content == '') {
            alert('Bạn chưa nhập đủ thông tin.');
            return;
        }
        $.ajax({
            type: "POST",
            url: "/ajax/postquestion.aspx",
            data: { name: name, email: email, content: content, intro: address, iid: $(this).attr('rel') }
        }).done(function (msg) {
            if (msg == 'success') {
                window.alert('Cảm ơn bạn đã gửi câu hỏi!');
                $('#txtnameinterview,#txtemailinterview,#txtaddressinterview,#txtcontentinterview').val('');
            } else if (msg == 'soon') {
                window.alert('Bạn vừa sử dụng chức năng này gần đây. Xin vui lòng nghỉ ngơi ít phút.');
            } else if (msg == 'invalidemail') {
                window.alert('Email bạn nhập không chính xác.');
            } else if (msg == 'invalid') {
                window.alert('Thông tin bạn nhập chưa đầy đủ.');
            } else {
                window.alert('Có lỗi xảy ra. Xin vui lòng thử lại.');
            }
        });
    });
}
$(document).ready(function() {
    if ($('.native-ad > div').children().length == 3) {
        $('.native-ad').remove();
    }
});

//rating
if ($('.rating > div').length > 0) {

    var captchaContainer = null;
    var onloadCallback = function () {
        
    };

    $('.rating > div').raty({
        path: '//static.thanhnien.vn/v3/app_themes/raty/images/',
        score: function () { return $(this).attr('data-score'); },
        click: function (score, evt) {
            $(this).attr('data-score', score);
            if (captchaContainer == null) {
                captchaContainer = grecaptcha.render('captcha_container', {
                    'sitekey': '6Lci1RATAAAAACC1Aww1IZrkmX3e9MvFPevnhXW6',
                    'callback': function (response) { }
                });
            } else {
                grecaptcha.reset(captchaContainer);
            }
            
            $('#rating_modal').modal();
            $('#btnratingsend').attr('rel', $(this).attr('rel')).attr('data-score', $(this).attr('data-score'));
        }
    });
    $('#btnratingsend').click(function (e) {
        e.preventDefault();
        //grecaptcha.execute('6LeeTowUAAAAABMbhzdzhc-NFn_89M69okIeT0Nx', { action: 'social' }).then(function (captcha) {
        var captcha = grecaptcha.getResponse(captchaContainer);
            if (captcha == '') {
                alert('Bạn vui lòng nhập mã Captcha');
                return false;
            }
            $.ajax({
                type: "POST",
                url: mainhost + "/ajax/authorrate.aspx",
                data: { id: $(this).attr('rel'), rate: $(this).attr('data-score'), captcha: captcha }
            }).done(function (msg) {
                if (msg == 'success') {
                    window.alert('Cảm ơn bạn đã đánh giá.');
                } else if (msg == '') {
                    window.alert('Bạn đã đánh giá tác giả này rồi.');
                } else if (msg == 'captcha') {
                    window.alert('Lỗi mã captcha. Xin vui lòng thử lại.');
                } else {
                    window.alert('Có lỗi xảy ra. Xin vui lòng thử lại sau ít phút.');
                }
                $('#rating').raty('reload');
                $('#btnratingclose').click();
                grecaptcha.reset(captchaContainer);
            });
        //});
    });
}

function htmlDecode(input) {
    var e = document.createElement('div');
    e.innerHTML = input;
    return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
}
//video
if ($('#post-player').length > 0) {
    showvideofull('post-player', htmlDecode($('#stvideo' + _stindex).html()), $('#stimage' + _stindex).html(), $('#post-player').width(), $('#post-player').height());
    $('#post-player').attr('auto', 'true').removeClass('story__thumb');
    $('#post-player video').attr('video-title', $('#sttitle' + _stindex).html());
    //$('#post-player-container').attr("video", $('#stvideo' + _stindex).html()).attr("img", $('#stimage' + _stindex).html())
    $('#storyvideotitle').html($('#sttitle' + _stindex).html());
    //$('#storyvideoavatar').attr('src', $('#stimage' + _stindex).html());
    //$('#storyvideotime').html($('#sttime' + _stindex).html());

    var videocount_ = 4;
    _stindex++;
    for (var _vi = 0; _vi < videocount_; _vi++) {
        if (_vi % 2 == 0) {
            $('#postvideolist').append('<li></li>');
        }
        _stindex++;
        if (_stindex >= _stcount) _stindex = 0;
        $('#postvideolist > li:last-child').append('<article class="story"><a href="javascript:void(0);" class="story__thumb" video="" img="' + $('#stimage' + _stindex).html() + '" con="post-player" idx="' + _stindex + '"><img src="' + $('#stimages' + _stindex).html() + '" alt=""/></a><h2><a href="javascript:void(0);" idx="' + _stindex + '" class="story__title" video="" img="' + $('#stimage' + _stindex).html() + '" con="post-player">' + $('#sttitle' + _stindex).html() + '</a></h2></article>');
    }
    $('#postvideolist li a').click(function (e) {
        $('#storyvideotitle').html($('#sttitle' + $(this).attr('idx')).html());
        var w_ = $('#post-player').width();
        var h_ = $('#post-player').height();
        $('#post-player').html('');
        showvideofull('post-player', htmlDecode($('#stvideo' + $(this).attr('idx')).html()), $('#stimage' + $(this).attr('idx')).html(), w_, h_);
        $('#post-player video').attr('video-title', $('#sttitle' + $(this).attr('idx')).html()).attr('auto', '');
    });
}
if ($('#contentAvatar video').length > 0) {
    $('#contentAvatar video').attr('video-title', $('#contentAvatar .imgcaption').text());
}
function strip_tags(_input) {
    return _input.replace(/(<([^>]+)>)/ig, "").replace(/(\n)/ig, ' ').trim().replace(/  /ig, ' ');
}

var scrollToComment = function () {
    $('html,body').animate({
        scrollTop: $('#txtcontent').offset().top - 120
    }, 500);
}
$('a[href=#commentbox]').click(function (e) {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    var lazyLoad = new LazyLoad({ elements_selector: '#abody img[data-src]' });
    lazyLoad.loadAll();
    window.setTimeout(scrollToComment, 500);
    window.setTimeout(scrollToComment, 1000);
    window.setTimeout(scrollToComment, 2000);
})
